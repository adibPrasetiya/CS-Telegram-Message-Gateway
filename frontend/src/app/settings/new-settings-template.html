<div class="settings-container">
  <!-- Header -->
  <div class="settings-header">
    <div class="header-content">
      <div class="header-title">
        <i class="fab fa-telegram-plane"></i>
        <div>
          <h1>Telegram Bot Configuration</h1>
          <p>Set up your Telegram bot for help desk notifications</p>
        </div>
      </div>
      <div class="header-status" *ngIf="botConfig">
        <div class="status-indicator" [class.connected]="botConfig.isConnected" [class.configured]="botConfig.isGroupConfigured">
          <i class="fas" [class.fa-check-circle]="botConfig.isConnected && botConfig.isGroupConfigured" 
             [class.fa-exclamation-triangle]="botConfig.isConnected && !botConfig.isGroupConfigured"
             [class.fa-times-circle]="!botConfig.isConnected"></i>
          <span>{{ getStatusText() }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Stepper -->
    <app-stepper [steps]="stepperSteps" (stepClick)="onStepClick($event)"></app-stepper>
    
    <!-- Step Content -->
    <div class="step-content">
      <!-- Step 1: Bot Token -->
      <div class="step-panel" *ngIf="currentStep === 'token'">
        <div class="step-header">
          <h2>Connect Your Telegram Bot</h2>
          <p>Enter your Telegram bot token to establish the connection</p>
        </div>

        <!-- Current Bot Info (if connected) -->
        <div class="current-bot-card" *ngIf="botConfig?.isConnected">
          <div class="bot-info">
            <div class="bot-avatar">
              <i class="fab fa-telegram-plane"></i>
            </div>
            <div class="bot-details">
              <h3>{{ '@' + (botConfig?.botUsername || '') }}</h3>
              <p>Connected and ready</p>
            </div>
            <div class="bot-status">
              <span class="status-badge connected">Connected</span>
            </div>
          </div>
          <div class="bot-actions">
            <button class="btn-secondary" (click)="editBotToken()">
              <i class="fas fa-edit"></i>
              Change Bot Token
            </button>
            <button class="btn-danger" (click)="disconnectBot()">
              <i class="fas fa-unlink"></i>
              Disconnect
            </button>
          </div>
        </div>

        <!-- Token Input Form -->
        <div class="token-form" [class.editing]="isEditingToken" *ngIf="!botConfig?.isConnected || isEditingToken">
          <div class="form-group">
            <label for="botToken">Bot Token</label>
            <div class="token-input-group">
              <input 
                id="botToken"
                type="password" 
                [(ngModel)]="botTokenInput" 
                placeholder="Enter bot token (e.g., 123456789:ABCdefGHijKLmnOPqrSTUvwxYZ)"
                class="form-input"
                [disabled]="isTestingConnection || isSavingToken">
              <button 
                class="btn-test"
                (click)="testBotConnection()"
                [disabled]="!botTokenInput || isTestingConnection || isSavingToken">
                <i *ngIf="!isTestingConnection" class="fas fa-plug"></i>
                <i *ngIf="isTestingConnection" class="fas fa-spinner fa-spin"></i>
                {{ isTestingConnection ? 'Testing...' : 'Test' }}
              </button>
            </div>
          </div>

          <!-- Test Result -->
          <div *ngIf="connectionTestResult" class="test-result">
            <div *ngIf="connectionTestResult.success" class="result-success">
              <i class="fas fa-check-circle"></i>
              <div class="result-content">
                <h4>Connection Successful!</h4>
                <p>Bot: <strong>{{ '@' + (connectionTestResult.botInfo?.username || '') }}</strong> ({{ connectionTestResult.botInfo?.firstName }})</p>
              </div>
              <button 
                class="btn-primary"
                (click)="saveBotToken()"
                [disabled]="isSavingToken">
                <i *ngIf="!isSavingToken" class="fas fa-save"></i>
                <i *ngIf="isSavingToken" class="fas fa-spinner fa-spin"></i>
                {{ isSavingToken ? 'Saving...' : 'Save & Continue' }}
              </button>
            </div>
            
            <div *ngIf="!connectionTestResult.success" class="result-error">
              <i class="fas fa-exclamation-triangle"></i>
              <div class="result-content">
                <h4>Connection Failed</h4>
                <p>{{ connectionTestResult.error }}</p>
              </div>
            </div>
          </div>

          <!-- Cancel Edit -->
          <div class="form-actions" *ngIf="isEditingToken">
            <button class="btn-secondary" (click)="cancelEditToken()">
              <i class="fas fa-times"></i>
              Cancel
            </button>
          </div>
        </div>

        <!-- Help Section -->
        <div class="help-section" *ngIf="!botConfig?.isConnected">
          <h3>How to get a Bot Token:</h3>
          <ol>
            <li>Open Telegram and search for <strong>@BotFather</strong></li>
            <li>Send <code>/newbot</code> command</li>
            <li>Follow the prompts to create your bot</li>
            <li>Copy the bot token and paste it above</li>
          </ol>
        </div>
      </div>

      <!-- Step 2: Group Setup -->
      <div class="step-panel" *ngIf="currentStep === 'group'">
        <div class="step-header">
          <h2>Configure Notification Group</h2>
          <p>Set up a Telegram group to receive help desk notifications</p>
        </div>

        <!-- Current Group (if configured) -->
        <div class="current-group-card" *ngIf="botConfig?.isGroupConfigured">
          <div class="group-info">
            <div class="group-avatar">
              <i class="fas fa-users"></i>
            </div>
            <div class="group-details">
              <h3>{{ botConfig?.groupTitle }}</h3>
              <p>Receiving notifications</p>
            </div>
            <div class="group-status">
              <span class="status-badge active">Active</span>
            </div>
          </div>
          <div class="group-actions">
            <button class="btn-secondary" (click)="sendTestNotification()">
              <i class="fas fa-paper-plane"></i>
              Send Test
            </button>
            <button class="btn-secondary" (click)="changeGroup()">
              <i class="fas fa-edit"></i>
              Change Group
            </button>
          </div>
        </div>

        <!-- Group Setup -->
        <div class="group-setup" *ngIf="!botConfig?.isGroupConfigured">
          <!-- Benefits -->
          <div class="benefits-card">
            <h3>Notification Types</h3>
            <div class="benefit-list">
              <div class="benefit-item">
                <i class="fas fa-comment-dots"></i>
                <span>New client messages</span>
              </div>
              <div class="benefit-item">
                <i class="fas fa-play-circle"></i>
                <span>Chat session started</span>
              </div>
              <div class="benefit-item">
                <i class="fas fa-stop-circle"></i>
                <span>Chat session ended</span>
              </div>
              <div class="benefit-item">
                <i class="fas fa-headset"></i>
                <span>CS activity updates</span>
              </div>
            </div>
          </div>

          <!-- Setup Actions -->
          <div class="setup-actions" *ngIf="!groupInvitationStatus.isWaitingForInvitation">
            <button class="btn-primary" (click)="startGroupSetup()">
              <i class="fas fa-users"></i>
              Start Group Setup
            </button>
          </div>

          <!-- Waiting for Invitation -->
          <div class="waiting-state" *ngIf="groupInvitationStatus.isWaitingForInvitation">
            <div class="waiting-header">
              <div class="pulse-indicator"></div>
              <h3>Waiting for Bot Invitation</h3>
              <p>Add <strong>{{ '@' + (botConfig?.botUsername || '') }}</strong> to your Telegram group</p>
            </div>
            
            <div class="setup-instructions">
              <h4>Setup Steps:</h4>
              <ol>
                <li>Open your Telegram group (or create a new one)</li>
                <li>Tap the group name → Add Members</li>
                <li>Search for <strong>{{ '@' + (botConfig?.botUsername || '') }}</strong></li>
                <li>Add the bot to the group</li>
                <li>Return here to confirm</li>
              </ol>
            </div>

            <div class="waiting-actions">
              <button class="btn-secondary" (click)="cancelGroupSetup()">
                <i class="fas fa-times"></i>
                Cancel Setup
              </button>
            </div>
          </div>

          <!-- Group Detected -->
          <div class="group-detected" *ngIf="groupInvitationStatus.detectedGroups.length > 0">
            <div class="detected-header">
              <i class="fas fa-check-circle"></i>
              <h3>Groups Detected!</h3>
              <p>Select the group you want to use for notifications</p>
            </div>
            
            <div class="group-list">
              <div 
                *ngFor="let group of groupInvitationStatus.detectedGroups" 
                class="group-option"
                [class.selected]="selectedGroupId === group.id"
                (click)="selectGroup(group.id)">
                <div class="group-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="group-info">
                  <h4>{{ group.title }}</h4>
                  <p>{{ group.type | titlecase }} • {{ group.memberCount || 'Unknown' }} members</p>
                </div>
                <div class="selection-indicator">
                  <i class="fas fa-check"></i>
                </div>
              </div>
            </div>
            
            <div class="confirmation-actions">
              <button class="btn-primary" (click)="confirmGroup()" [disabled]="!selectedGroupId">
                <i class="fas fa-check"></i>
                Confirm & Enable Notifications
              </button>
              <button class="btn-secondary" (click)="cancelGroupSetup()">
                <i class="fas fa-times"></i>
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Notifications -->
      <div class="step-panel" *ngIf="currentStep === 'notifications'">
        <div class="step-header">
          <h2>Notification Settings</h2>
          <p>Customize which events trigger notifications</p>
        </div>

        <div class="notification-settings">
          <div class="setting-group">
            <h3>Client Events</h3>
            <div class="setting-item">
              <div class="setting-info">
                <h4>New Client Messages</h4>
                <p>Get notified when clients send new messages</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" [checked]="true">
                <span class="slider"></span>
              </label>
            </div>
            <div class="setting-item">
              <div class="setting-info">
                <h4>Client Connected</h4>
                <p>Notification when a new client starts a conversation</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" [checked]="true">
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="setting-group">
            <h3>Session Events</h3>
            <div class="setting-item">
              <div class="setting-info">
                <h4>Session Started</h4>
                <p>When a customer service agent starts handling a session</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" [checked]="true">
                <span class="slider"></span>
              </label>
            </div>
            <div class="setting-item">
              <div class="setting-info">
                <h4>Session Ended</h4>
                <p>When a chat session is closed</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" [checked]="true">
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>

        <div class="settings-actions">
          <button class="btn-primary">
            <i class="fas fa-save"></i>
            Save Settings
          </button>
        </div>
      </div>

      <!-- Step 4: Complete -->
      <div class="step-panel" *ngIf="currentStep === 'complete'">
        <div class="completion-card">
          <div class="completion-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h2>Configuration Complete!</h2>
          <p>Your Telegram bot is now configured and ready to send notifications</p>
          
          <div class="summary-info">
            <div class="summary-item">
              <span class="label">Bot:</span>
              <span class="value">{{ '@' + (botConfig?.botUsername || '') }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Group:</span>
              <span class="value">{{ botConfig?.groupTitle }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Status:</span>
              <span class="value status-active">Active</span>
            </div>
          </div>

          <div class="completion-actions">
            <button class="btn-primary" (click)="sendTestNotification()">
              <i class="fas fa-paper-plane"></i>
              Send Test Notification
            </button>
            <button class="btn-secondary" (click)="goToStep('notifications')">
              <i class="fas fa-cog"></i>
              Manage Settings
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>